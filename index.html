<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å°éºµå¤§æˆ°æµæ„Ÿç—…æ¯’ - æ‰‹æ©Ÿç‰ˆ</title>
    <style>
        body { 
            margin: 0; 
            overflow: hidden; 
            background: #000; 
            font-family: "Microsoft JhengHei", sans-serif; 
            touch-action: none; /* é˜²æ­¢æ‰‹æ©Ÿç€è¦½å™¨ç¸®æ”¾èˆ‡æ»‘å‹•å¹²æ“¾ */
        }
        canvas { display: block; background-color: #000; }

        /* UI å±¤é¢è¨­å®š - æ”¾åœ¨é ‚éƒ¨é˜²æ­¢æ‰‹æŒ‡é®æ“‹ */
        #ui-layer {
            position: absolute; top: 10px; left: 10px; right: 10px;
            color: white; text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            pointer-events: none; z-index: 10; display: flex; justify-content: space-between;
        }
        .bar-label { font-size: 14px; font-weight: bold; margin-bottom: 2px; }
        .bar-container { width: 140px; height: 12px; background: rgba(255,255,255,0.3); border: 1.5px solid #fff; border-radius: 8px; overflow: hidden; }
        #fever-bar { width: 0%; height: 100%; background: linear-gradient(to right, #ffeb3b, #f44336); transition: width 0.2s; }
        
        #boss-hp-ui { display: none; text-align: right; }
        #boss-bar-container { width: 140px; height: 12px; background: rgba(0,0,0,0.5); border: 1.5px solid #ff0055; border-radius: 5px; }
        #boss-hp-fill { width: 100%; height: 100%; background: #ff0055; }

        /* ç‰¹æ•ˆåœ–å±¤ */
        #nuke-effect {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            object-fit: cover; display: none; z-index: 5;
            pointer-events: none; mix-blend-mode: screen;
        }

        /* çµå±€å±¤ */
        #overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); display: none; flex-direction: column;
            justify-content: center; align-items: center; color: white; text-align: center; z-index: 100;
            padding: 20px; box-sizing: border-box;
        }
        h1 { font-size: 32px; margin-bottom: 10px; color: #fff; }
        p { font-size: 18px; margin-bottom: 30px; line-height: 1.5; }
        button {
            padding: 15px 40px; font-size: 20px; cursor: pointer;
            background: #2ecc71; border: none; color: white; border-radius: 50px;
            box-shadow: 0 4px 15px rgba(46, 204, 113, 0.4);
        }
    </style>
</head>
<body>

<div id="ui-layer">
    <div id="player-ui">
        <div class="bar-label">ç™¼ç‡’å€¼ (Fever)</div>
        <div class="bar-container"><div id="fever-bar"></div></div>
    </div>
    <div id="boss-hp-ui">
        <div class="bar-label" style="color: #ff0055;">æµæ„Ÿå¤§é­”ç‹</div>
        <div id="boss-bar-container"><div id="boss-hp-fill"></div></div>
    </div>
</div>

<img id="nuke-effect" src="nuke_fx.gif">

<div id="overlay">
    <h1 id="msg-title"></h1>
    <p id="msg-desc"></p>
    <button onclick="resetGame()">é‡æ–°æŒ‘æˆ°</button>
</div>

<canvas id="gameCanvas"></canvas>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const nukeImg = document.getElementById('nuke-effect');

// éŠæˆ²åƒæ•¸
let fever = 0;
let bossHP = 1000;
const FEVER_THRESHOLD = 100;
const BOSS_MAX_HP = 1000;
let gameState = 'playing'; 
let isBossStage = false;
let score = 0;
let lastAutoFire = 0;

// è¨­ç½®ç•«å¸ƒç‚ºå…¨è¢å¹•
function resizeCanvas() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
}
window.addEventListener('resize', resizeCanvas);
resizeCanvas();

// ç´ æè¼‰å…¥
const assets = {
    hero: 'hero.png',
    virus: 'virus_small.png',
    boss: 'boss.png',
    pill: 'pill.png',
    syrup: 'syrup.png',
    tamiflu: 'tamiflu.png',
    bg: 'bg.jpg'
};
const images = {};
Object.keys(assets).forEach(key => {
    images[key] = new Image();
    images[key].src = assets[key];
});

// ç‰©ä»¶é¡åˆ¥
class Player {
    constructor() {
        this.w = 80; this.h = 80; // æ‰‹æ©Ÿç‰ˆç•¥å°
        this.x = canvas.width / 2 - this.w / 2;
        this.y = canvas.height - 150;
    }
    draw() {
        ctx.drawImage(images.hero, this.x, this.y, this.w, this.h);
    }
}

class Bullet {
    constructor(x, y, type = 'normal') {
        this.x = x; this.y = y; this.type = type;
        this.speed = 15; this.w = (type==='normal')?20:60; this.h = (type==='normal')?40:80;
    }
    update() { this.y -= this.speed; }
    draw() {
        ctx.drawImage(this.type==='normal'?images.pill:images.tamiflu, this.x, this.y, this.w, this.h);
    }
}

class Enemy {
    constructor(isBoss = false) {
        this.isBoss = isBoss;
        this.w = isBoss ? 200 : 60; this.h = isBoss ? 200 : 60;
        this.x = isBoss ? (canvas.width/2 - 100) : (Math.random() * (canvas.width - this.w));
        this.y = -250;
        this.speed = isBoss ? 0.5 : (2 + Math.random() * 3);
        this.hp = isBoss ? BOSS_MAX_HP : 1;
        this.dir = 1; // Boss å·¦å³ç§»å‹•ç”¨
    }
    update() {
        this.y += this.speed;
        if (this.isBoss) {
            this.x += this.dir * 2;
            if (this.x <= 0 || this.x >= canvas.width - this.w) this.dir *= -1;
            if (this.y > 50) this.y = 50; // Boss åœåœ¨ä¸Šæ–¹å€åŸŸ
        }
    }
    draw() {
        ctx.drawImage(this.isBoss ? images.boss : images.virus, this.x, this.y, this.w, this.h);
    }
}

class Item {
    constructor(x, y, type) {
        this.x = x; this.y = y; this.type = type;
        this.w = 50; this.h = 50;
    }
    update() { this.y += 3; }
    draw() {
        ctx.drawImage(images[this.type], this.x, this.y, this.w, this.h);
    }
}

// å¯¦ä¾‹åŒ–
let player = new Player();
let bullets = [];
let enemies = [];
let items = [];

// --- æ‰‹æ©Ÿè§¸æ§æ§åˆ¶ ---
function handleTouch(e) {
    if (gameState !== 'playing') return;
    const touch = e.touches[0];
    // è®“ä¸»è§’ä¸­å¿ƒè·Ÿéš¨æ‰‹æŒ‡ï¼Œä¸¦é©ç•¶åç§»è®“æ‰‹æŒ‡ä¸æ“‹ä½ä¸»è§’
    player.x = touch.clientX - player.w / 2;
    player.y = touch.clientY - player.h - 20; 

    // é‚Šç•Œé™åˆ¶
    if (player.x < 0) player.x = 0;
    if (player.x > canvas.width - player.w) player.x = canvas.width - player.w;
    if (player.y < 0) player.y = 0;
    if (player.y > canvas.height - player.h) player.y = canvas.height - player.h;
}

canvas.addEventListener('touchstart', (e) => {
    handleTouch(e);
    // é»æ“Šç™¼å°„é¡å¤–å­å½ˆ
    bullets.push(new Bullet(player.x + player.w/2 - 10, player.y));
});
canvas.addEventListener('touchmove', (e) => {
    e.preventDefault();
    handleTouch(e);
}, { passive: false });

// ç¢°æ’æª¢æŸ¥
function checkCollision(a, b) {
    return a.x < b.x + b.w && a.x + a.w > b.x && a.y < b.y + b.h && a.y + a.h > b.y;
}

// è§¸ç™¼å…‹æµæ„Ÿå¤§çµ•
function triggerNuke() {
    nukeImg.style.display = 'block';
    let currentSrc = nukeImg.src;
    nukeImg.src = ""; nukeImg.src = currentSrc;

    enemies.forEach(en => { if(!en.isBoss) score++; });
    enemies = enemies.filter(en => en.isBoss);
    if (isBossStage) bossHP -= 200;

    setTimeout(() => { nukeImg.style.display = 'none'; }, 1800);
}

function update() {
    if (gameState !== 'playing') return;

    // è‡ªå‹•å°„æ“Šé‚è¼¯ (æ¯ 400ms å°„ä¸€é¡†)
    let now = Date.now();
    if (now - lastAutoFire > 400) {
        bullets.push(new Bullet(player.x + player.w/2 - 10, player.y));
        lastAutoFire = now;
    }

    // ç”Ÿæˆæ•µäºº
    if (score >= 25 && !isBossStage) {
        isBossStage = true;
        enemies.push(new Enemy(true));
        document.getElementById('boss-hp-ui').style.display = 'block';
    }
    if (!isBossStage && Math.random() < 0.04) enemies.push(new Enemy());

    // å­å½ˆè™•ç†
    bullets.forEach((b, bi) => {
        b.update();
        enemies.forEach((e, ei) => {
            if (checkCollision(b, e)) {
                if (e.isBoss) {
                    bossHP -= 10;
                    bullets.splice(bi, 1);
                } else {
                    if (Math.random() < 0.15) items.push(new Item(e.x, e.y, 'syrup'));
                    else if (Math.random() < 0.08) items.push(new Item(e.x, e.y, 'tamiflu'));
                    enemies.splice(ei, 1);
                    bullets.splice(bi, 1);
                    score++;
                }
            }
        });
        if (b.y < -100) bullets.splice(bi, 1);
    });

    // æ•µäººè™•ç†
    enemies.forEach((e, ei) => {
        e.update();
        if (checkCollision(player, e)) {
            fever += e.isBoss ? 1 : 15;
            if (!e.isBoss) enemies.splice(ei, 1);
        }
        if (e.y > canvas.height) enemies.splice(ei, 1);
    });

    // é“å…·è™•ç†
    items.forEach((it, ii) => {
        it.update();
        if (checkCollision(player, it)) {
            if (it.type === 'syrup') fever = Math.max(0, fever - 25);
            else triggerNuke();
            items.splice(ii, 1);
        }
        if (it.y > canvas.height) items.splice(ii, 1);
    });

    // UI æ›´æ–°
    document.getElementById('fever-bar').style.width = fever + '%';
    if (isBossStage) {
        document.getElementById('boss-hp-fill').style.width = (bossHP / BOSS_MAX_HP * 100) + '%';
    }

    if (fever >= FEVER_THRESHOLD) endGame(false);
    if (bossHP <= 0) endGame(true);
}

function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    if (images.bg.complete) {
        ctx.drawImage(images.bg, 0, 0, canvas.width, canvas.height);
    }

    items.forEach(it => it.draw());
    bullets.forEach(b => b.draw());
    enemies.forEach(e => e.draw());
    player.draw();

    if (gameState === 'playing') requestAnimationFrame(() => {
        update();
        draw();
    });
}

function endGame(isWin) {
    gameState = isWin ? 'win' : 'over';
    const overlay = document.getElementById('overlay');
    overlay.style.display = 'flex';
    
    if (isWin) {
        document.getElementById('msg-title').innerText = "ğŸ† æˆ°å‹æµæ„Ÿï¼";
        document.getElementById('msg-title').style.color = "#2ecc71";
        document.getElementById('msg-desc').innerText = "æ­å–œå°éºµå¾æµæ„Ÿç•¢æ¥­äº†ï¼\nä½ ç¾åœ¨æ“æœ‰è¶…ç´šæŠ—é«”ï¼Œè¶…ç´šå¼·å£¯ï¼";
    } else {
        document.getElementById('msg-title').innerText = "ğŸ’¤ éœ€è¦ä¼‘æ¯...";
        document.getElementById('msg-title').style.color = "#f44336";
        document.getElementById('msg-desc').innerText = "ç—…æ¯’å¤ªå¼·äº†ï¼Œå°éºµç´¯å¾—ç¡è‘—äº†ã€‚\nå–å£æ°´ã€ä¼‘æ¯ä¸€ä¸‹å†ä¾†æŒ‘æˆ°ï¼";
    }
}

function resetGame() {
    fever = 0; score = 0; bossHP = BOSS_MAX_HP;
    isBossStage = false; gameState = 'playing';
    enemies = []; bullets = []; items = [];
    document.getElementById('overlay').style.display = 'none';
    document.getElementById('boss-hp-ui').style.display = 'none';
    player.x = canvas.width / 2 - player.w / 2;
    player.y = canvas.height - 150;
    draw();
}

// è³‡æºè¼‰å…¥æª¢æŸ¥
let loaded = 0;
const totalAssets = Object.keys(assets).length;
Object.values(images).forEach(img => {
    img.onload = () => {
        loaded++;
        if (loaded === totalAssets) draw();
    };
});
</script>
</body>
</html>
